---
title: "covid-vignette-api"
author: "Min-Jung Jung"
date: "9/20/2021"
output:   
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This project is to create a vignette about contacting an API. I created functions to download data via interacting endpoints. I will show this process with COVID API. 


# Reqired pakages

I used following packages to set up function, data manipulation, and analysis with COVID API:

  * `knitr`: to generate pretty tables of date using the `kable()` function.  
  * `tidyverse`: to manipulate data, generate plots (via `ggplot2`), and to use piping/chaining.
  * `rmarkdown`: to knit output files manually using the `render()` function.  
  * `jsonlite`: to pull data from various endpoints of the Covid 19 APIs.
  
```{r, echo=TRUE, warning = FALSE, message=FALSE, include=FALSE}
library(ggplot2)
library(tidyverse)
library(jsonlite)
library(knitr)
library(httr)
library(tidytext)
library(lubridate)
```

# JSON Data

JSON, also known as [*Java Script Object Notation*](https://www.json.org/json-en.html) is a text based format for storing and/or transporting data. JSON is used across the internet and databases because of its text based format for storing data. In addition, JSON can represent 2D data, [hierarchical data](https://en.wikipedia.org/wiki/Hierarchical_database_model), and use key-value pairs.

Since JSON is a text based format, we need to load in R packages that can handle the text based format.

# Packages used for reading JSON data in R

Here are R packages that can be used to work with JSON data:

* `rjson`
* `RJSONIO`
* `jsonlite`

For this project, `rjson` and `jsonlite` is used.

Couple resources for understanding the functionality of `rjson` and `jsonlite`:

1. [https://cran.r-project.org/web/packages/rjson/rjson.pdf](https://cran.r-project.org/web/packages/rjson/rjson.pdf)

2. [https://cran.r-project.org/web/packages/jsonlite/jsonlite.pdf](https://cran.r-project.org/web/packages/jsonlite/jsonlite.pdf)

# Contact the Covid Data API

To access the [Covid Data](https://documenter.getpostman.com/view/10808728/SzS8rjbc), we need to get a URL with the name of the table and attributes we want to pull from it.

In addition, I wrote 6 more functions that take different endpoints.

#Base url

```{r}
base_url = "https://api.covid19api.com"
```

## country name

#This function is to generate data.frame of country name and Slug.

```{r}
country_Name <- function(){
  country <- GET("https://api.covid19api.com/countries")
  countrylist <- fromJSON(rawToChar(country$content))
  countrylist1 <- as_tibble(data.frame(Country = countrylist$Country, Slug = countrylist$Slug))
  return(countrylist1)
}

countryName <- country_Name()
countryName
```

## `Confirmed Cases by different contries` from March 1st, 2020 to September 21st, 2021

#This function interacts with the `By Country Total` endpoint. 
```{r}
get_confirmed_cases <- function(country){
     if(country %in% countryName$Slug){
  full_url = paste0(base_url,"/total/country/",country,"/status/confirmed?from=2020-03-01T00:00:00Z&to=2021-09-30T00:00:00Z")
  confirmed_cases_text = content(GET(url=full_url),"text")
  confirmed_cases_json = fromJSON(confirmed_cases_text)
      covid_confirmed_cases <- confirmed_cases_json %>% select(Country, Cases, Status, Date) #%>% rename(ConfirmedCases =  Cases) 
  return(covid_confirmed_cases)
     }
        else {
      message <- paste("ERROR: Argument for country was not found in the Slug.", 
                       "Look up countryName to find the country you are looking for and use Slug.")
      stop(message)
    }
}

```

## `Death Cases by different contries` from March 1st, 2020 to September 21st, 2021

#This function interacts with the `By Country Total` endpoint, but modified the status as deaths. 

```{r}
get_deaths_cases <- function(country){
    if(country %in% countryName$Slug){
  full_url = paste0(base_url,"/total/country/",country,"/status/deaths?from=2020-03-01T00:00:00Z&to=2021-09-30T00:00:00Z")
  deaths_cases_text = content(GET(url=full_url),"text")
  deaths_cases_json = fromJSON(deaths_cases_text)
       covid_deaths_cases <- deaths_cases_json  %>% select(Country, Cases, Status, Date) #%>% rename(DeathsCases =  Cases) 
  return(covid_deaths_cases)
    }
        else {
      message <- paste("ERROR: Argument for country was not found in the Slug.", 
                       "Look up countryName to find the country you are looking for and use Slug.")
      stop(message)
    }
}
```

## `Recovered Cases by different contries` from March 1st, 2020 to September 21st, 2021

#This function interacts with the `By Country Total` endpoint, but modified the status as recovered.

```{r}
get_recovered_cases <- function(country){
  if(country %in% countryName$Slug){
  full_url = paste0(base_url,"/total/country/", country,"/status/recovered?from=2020-03-01T00:00:00Z&to=2021-09-30T00:00:00Z")
  recovered_cases_text = content(GET(url=full_url),"text")
  recovered_cases_json = fromJSON(recovered_cases_text)
       covid_recovered_cases <- recovered_cases_json  %>% select(Country, Cases, Status, Date) #%>% rename(RecoveredCases =  Cases)
  return(covid_recovered_cases)
  }
      else {
      message <- paste("ERROR: Argument for country was not found in the Slug.", 
                       "Look up countryName to find the country you are looking for and use Slug.")
      stop(message)
    }
}
```


## `U.S.A cases by state`

#This function interacts with the `Day One Live` endpoint. confrimed cases only

```{r}
get_cases_bystate <- function(state_name){
  state_name <- tolower(state_name)
  two_word_states = list("new hampshire", "new jersey", "new mexico","new york","north carolina","north dakota","south carolina","south dakota", "distrct of columbia", "puerto rico","Northern Mariana Islands", "Virgin Islands", "Rhode Island")
  if (state_name %in% two_word_states){
     full_url = paste0(base_url,"/dayone/country/united-states/status/confirmed/live?province=",state_name)
     URLencode(full_url)
    covid_cases_by_states_text = content(GET(url=URLencode(full_url)),"text")
    covid_cases_by_states_json = fromJSON(covid_cases_by_states_text)
  }
    else{
    full_url = paste0(base_url,"/dayone/country/united-states/status/confirmed/live?province=",state_name)
    covid_cases_by_states_text = content(GET(url=full_url),"text")
    covid_cases_by_states_json = fromJSON(covid_cases_by_states_text)
    }
     covid_cases_by_states <- covid_cases_by_states_json %>% select(Country, Province, City, Cases, Status, Date) 
  return(covid_cases_by_states)
}

nc_stateData <- get_cases_bystate("North Carolina")

```

## `Summary cases by Countries`


```{r}
covid_summary_cases <- function(){
   full_url = paste0(base_url,"/summary")
   covid_summary_text <- content(GET(url=full_url),"text")
   covid_cases_summary_json <- fromJSON(covid_summary_text)
   covid_cases_summary1 <- data.frame(covid_cases_summary_json$Countries)  
   covid_cases_summary2 <- as_tibble(covid_cases_summary1)
   return(covid_cases_summary2)
}

covidSum <- covid_summary_cases()

``` 


```{r}
get_live_cases <- function(country){
       if(country %in% countryName$Slug){
   full_url = paste0(base_url,"/live/country/",country,"/status/confirmed/date/2021-07-01T00:00:00Z")
    covid_cases_live_text = content(GET(url=full_url),"text")
    covid_cases_live_json = fromJSON(covid_cases_live_text)
      covid_state_cases <- covid_cases_live_json  %>% select(Country, Province, Confirmed, Deaths, Active, Date) #%>% rename(RecoveredCases =  Cases)
      return(covid_state_cases)
       }
      else {
      message <- paste("ERROR: Argument for country was not found in the Slug.", 
                       "Look up countryName to find the country you are looking for and use Slug.")
      stop(message)
    }
}

us_liveCases <- get_live_cases("united-states")

```

https://www.statista.com/chart/20978/coronavirus-cases-us-map/
```{r}
#As of July 28,2020 CDC covid case map
#https://twitter.com/cdcgov/status/1288609081696169990

#we can create a function that will manipulate our data to prepare for data summaries and visualization
newcolumnData <- function(dataset){
  dataset <- dataset %>% 
            mutate("DeathRate"= (Deaths/Confirmed)*100, 
                   "DeathRateStatus"= if_else(DeathRate > 10, "serious",
                                  if_else(DeathRate > 5, "high", 
                                          if_else(DeathRate >2, "medium", "low"))), 
                   "RiskStatus" = if_else(Confirmed > 174973, "Veryhigh",
                                    if_else(Confirmed > 82530, "high", 
                                      if_else(Confirmed > 39337, "mediumhigh", 
                                        if_else(Confirmed > 18725, "medium", 
                                          if_else(Confirmed > 6173, "mediumlow","low")))))
                                  )            
  return(dataset)
}
```
```{r}

new_live_07_28_2021 <- us_liveCases %>% filter(Date == "2021-07-28T00:00:00Z")

newcolumnData1 <- newcolumnData(new_live_07_28_2021) %>% as_tibble()
newcolumnData1
```


```{r}

#https://ourworldindata.org/grapher/biweekly-confirmed-covid-19-cases
#we can create a function that will manipulate our data to prepare for data summaries and visualization
newAddData_state <- function(dataset){
  dataset1 <- dataset %>% 
            mutate("TotalDeathRate"= (TotalDeaths/TotalConfirmed)*100, 
                   "TotalDeathRateStatus"= if_else(TotalDeathRate > 10, "serious",
                                  if_else(TotalDeathRate > 5, "high", 
                                          if_else(TotalDeathRate >2, "medium", "low"))), 
                   "Active" = (TotalConfirmed-TotalDeaths), 
                   "RiskStatus" = if_else(TotalConfirmed > 100000, "Veryhigh",
                                    if_else(TotalConfirmed > 50000, "high", 
                                      if_else(TotalConfirmed > 10000, "mediumhigh", 
                                        if_else(TotalConfirmed > 1000, "medium", 
                                          if_else(TotalConfirmed > 100, "mediumlow","low")))))
            )

  return(dataset1)
}

```




```{r}
#countryName <- country_Name()

indiaConfirmed <- get_confirmed_cases("india")

usConfirmed <- get_confirmed_cases("united-states")
brazilConfirmed <- get_confirmed_cases("brazil")
ukConfirmed <- get_confirmed_cases("united-kingdom")
russiaConfirmed <- get_confirmed_cases("russia")

indiaDeaths <- get_deaths_cases("india")

usDeaths <- get_deaths_cases("united-states") 

inRecovered <- get_recovered_cases("india")
usRecovered <- get_recovered_cases("united-states")

#stateCases <- get_cases_bystate("North Carolina")

#covidSummary <- covid_summary_cases()

#us_liveCase <- get_live_cases("united-states")

in_liveCase <- get_live_cases("india") 

newCovidSummary <- newAddData_state(covidSum)

```
# Exploratory Data Analysis

## Contigency Tables/ Numerical Summaries

```{r}
# combining three datasets

#confirm_subset <- usConfirmed %>% select(Country, Cases,Status, Date)
#death_subset <- usDeaths %>% select(Country, Cases,Status)
#recover_subset <- usRecovered %>% select(Country, Cases,Status) 
five_confirm <- rbind(usConfirmed, brazilConfirmed, indiaConfirmed, ukConfirmed, russiaConfirmed)


five_com1 <- five_confirm %>% filter(Date == "2021-09-30T00:00:00Z")
five_com1

five_confirm_table <- table(five_com1$Country)
five_confirm_table

```






```{r}
# Contingency table

#Worldwide

TotalDeathRate_status <- table(newCovidSummary$TotalDeathRateStatus) 

TotalDeathRate_status1 <- TotalDeathRate_status[c(4,1,3,2)]

kable(TotalDeathRate_status1) #col.names = c("Total DeathRate Status", "Count"))



TotalRisk_status <- table(newCovidSummary$RiskStatus) 

TotalRisk_status1 <- TotalRisk_status[c(5,1,4,3,2)]

kable(TotalRisk_status1) #col.names = c("Risk Status", "Count"))
```



```{r}
# Contingency table 
#United Status
usDeathRate_status <- table(newcolumnData1$RiskStatus, newcolumnData1$DeathRateStatus)
kable(usDeathRate_status)
```

```{r}
Summarydata_World <- newCovidSummary %>% group_by(RiskStatus) %>% summarise(Avg = mean(TotalConfirmed), Med = median((TotalConfirmed), IQR = IQR(TotalConfirmed), Var = var(TotalConfirmed)) )

Summarydata_World
```
```{r}
newCovidSummary %>% group_by(TotalDeathRateStatus) %>% summarise(Avg = mean(TotalConfirmed), Med = median(TotalConfirmed))
```
```{r}
newCovidSummary %>% group_by(TotalDeathRateStatus) %>% summarise(Avg = mean(TotalDeathRate), Med = median(TotalDeathRate), Var = var(TotalDeathRate), IQR = IQR(TotalDeathRate))
```

```{r}
cor(newCovidSummary$TotalConfirmed, newCovidSummary$TotalDeaths)

```

```{r}
# kable(stateCases)

# kable(confirmed)
# kable(deaths)
# kable(recovered)
# kable(caseSum)
# kable(liveCase)
```

## Graphical Summaries


# Bar plot
top_state_09_30_2021 <- country_liveCase %>% filter(Date == "2021-09-30T00:00:00Z") %>% arrange(desc(Active))
top_10_state_09_30_2021 <- top_state_09_30_2021[1:10,]

ggplot(data=top_10_state_09_30_2021, aes(x=Province, y=Active)) +
  geom_bar(stat="identity", fill="green")




  geom_text(aes(label=Cases), vjust=1.6, color="black", size=3.5)+   theme_minimal()+ ggtitle("Top 10 North Carolina Cities Confirmed Covid Cases on September 23rd, 2021.")
```{r}
ggplot(data=newCovidSummary, aes(x=RiskStatus)) +
  geom_bar(aes(fill = as.factor(TotalDeathRateStatus))) + labs(x = " Risk Status", title = "Bar plot of Risk status in 192 countries") + theme(axis.text.x = element_text(angle = 45, hjust=1)) + scale_fill_discrete(name = "DeathRate Status")
```




```{r}
ggplot(data=newcolumnData1, aes(x=RiskStatus)) +
  geom_bar(aes(fill = as.factor(DeathRateStatus))) + labs(x = " Risk Status", title = "Bar plot of Risk status in 52 states in the U.S") + theme(axis.text.x = element_text(angle = 45, hjust=1)) + scale_fill_discrete(name = "DeathRate Status")
```

```{r}
# Bar plot
top_country<- newCovidSummary %>% arrange(desc(TotalConfirmed))
top_10_country <- top_country[1:10,]

ggplot(data=top_10_country, aes(x=Country, y=TotalConfirmed)) +
  geom_bar(stat="identity", fill="yellowgreen") + geom_text(aes(label=TotalConfirmed), vjust=1.6, color="black", size=3.5) + theme(axis.text.x = element_text(angle = 45, hjust=1)) + labs(x = "Country", title = "Top 10 countries on Total Confirmed case")


```
```{r}
# Bar plot
top_country<- newCovidSummary %>% arrange(desc(NewDeaths))
top_10_country <- top_country[1:10,]

ggplot(data=top_10_country, aes(x=Country, y=NewDeaths)) +
  geom_bar(stat="identity", fill="orange") +
  labs(x = "Country", title = "Top 10 countries on newDeath case") + geom_text(aes(label=NewDeaths), vjust=1.6, color="black", size=3.5) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


```

  
```{r}
# Bar plot
top_city_09_30_2021 <- nc_stateData %>% filter(Date == "2021-09-30T00:00:00Z") %>% arrange(desc(Cases))
top_10_city_09_30_2021 <- top_city_09_30_2021[1:10,]

ggplot(data=top_10_city_09_30_2021, aes(x=City, y=Cases)) +
  geom_bar(stat="identity", fill="steelblue") + geom_text(aes(label=Cases), vjust=1.6, color="white", size=3.5) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) + labs(x = "NC CITY", title = "Top 10 City in North Carolina on Confirmed case")


```

  geom_text(aes(label=Cases), vjust=1.6, color="white", size=3.5)+
stat="identity", theme_minimal()

  + ggtitle("Top 10 North Carolina Cities Confirmed Covid Cases on September 30, 2020.")
stateCases

# Histogram
```{r}
top_country<- newCovidSummary %>% arrange(desc(TotalConfirmed))
top_20_country <- top_country[1:20,]
```
```{r}
ggplot(newCovidSummary, aes(x=NewDeaths)) + geom_histogram(color="orange2", fill="red", size = 1, binwidth=100)+geom_vline(aes(xintercept=mean(NewDeaths)),color="blue", linetype="dashed", size=1) + labs(x = "New Death Case", title = "Histogram of new death cases today: 192 countries")

#Blue line is the mean line.

```




```{r}
# Histogram
ggplot(top_city_09_30_2021, aes(x=Cases)) + geom_histogram(color="darkblue",fill="red",binwidth=1000)+geom_vline(aes(xintercept=mean(Cases)),color="blue", linetype="dashed", size=1)+ggtitle("Histogram of Confirmed Cases in North Carolina Cities on September 30, 2021")

#Blue line is the mean line.
```

```{r}
# Box plot
us_subset <- usConfirmed %>% select(Country, Cases,Status)
in_subset <- indiaConfirmed %>% select(Country, Cases,Status)
us_in <- rbind(us_subset, in_subset)

boxplot(Cases~Country,data=us_in, main="United States and India Covid Cases Comparison using Box plot",xlab="Country", ylab="Cases",col=(c("gold","darkgreen")))
```
```{r}

uscaselive <- us_liveCases  %>% 
  select(Country, Province, Active, Date) 
incaselive <- in_liveCase %>%
  select(Country, Province, Active, Date)
uslive_inlive <- rbind(uscaselive, incaselive )

boxplot(Active~Country,data=uslive_inlive, main="United States and India Covid live Cases Comparison using Box plot",xlab="Country", ylab="Active",col=(c("gold","darkgreen")))


```
```{r}
# Box plot
Summary_world <- newCovidSummary %>% select(Country, TotalConfirmed, RiskStatus)

boxplot(TotalConfirmed~RiskStatus,data=Summary_world, main="World Covid Cases Box plot",
   xlab="RiskStatus", ylab="TotalConfirmed",col=(c("darkgreen")))
```

```{r}
# Scatter plot
covid_cases_by_states2 <- nc_stateData

covid_cases_by_states2 <- aggregate(list(Cases=covid_cases_by_states2$Cases),
                              by=list(Date=cut(as.POSIXct(covid_cases_by_states2$Date),"month")),sum)

ggplot(data = covid_cases_by_states2, aes(x = Date, y = Cases))+
  geom_point() + theme(axis.text.x = element_text(angle = 45,hjust=1)) + 
  ggtitle("Scatterplot of Confirmed Covid Cases in North Carolina Cities from November 2020 to September 2021") 
```


```{r}
# Scatter plot country summary
ggplot(data = newCovidSummary, aes(x = TotalConfirmed, y = TotalDeaths))+
  geom_point() + theme(axis.text.x = element_text(angle = 45,hjust=1)) + 
  ggtitle("Scatterplot of Confirmed Covid Cases by Death Covid Cases") + geom_smooth(method = lm, color = "blue")  


```


